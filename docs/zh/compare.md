# 代码审查 Agent 设计方案对比

本文档旨在对比两种不同的自动化代码审查 Agent 设计方案，分析它们的优劣，并为未来的系统设计提供参考。

## 方案一：原始 Agent 设计 (基于 `github-code-review` 和 `github-diff-review`)

这是我们最初分析的基于现有 Agent 实现的方案。

### 架构

- 采用**协调器-执行者 (Orchestrator-Executor)** 模式。
- `github-code-review` (协调器): 负责获取 Pull Request (PR) 信息，管理整体流程，并将文件级审查任务分发给执行者。
- `github-diff-review` (执行者): 负责接收单个文件的审查任务，获取该文件的完整内容和代码差异 (Diff/Patch)，进行分析。

### 核心能力

- 自动化执行 PR 代码审查流程。
- 协调器获取 PR 元数据（描述、文件列表等）。
- 执行器专注于分析**单个文件**的代码差异，识别其内部的潜在问题（逻辑、风格、安全等）。
- 执行器输出结构化的审查结果 (Findings)，包含文件路径、行号、严重性、类别和评论。
- 协调器聚合所有文件的 Findings，生成初步报告，并可选地发布评论。

### 主要优势

- **模块化:** 职责清晰，协调器和执行器分离。
- **自动化:** 实现了基本的 Code Review 流程自动化。
- **结构化输出:** 标准化的 Findings 格式便于后续处理。

### 核心缺陷

- **严重缺乏跨文件上下文理解:** 这是最主要的限制。执行器只关注单个文件，无法理解一个文件的修改如何影响代码库中的其他部分。
- **外部依赖处理不可靠:** 对于从其他文件导入的函数或类，执行器仅能基于当前文件的使用情况进行**推断**，其判断非常有限且不准确。常常导致产生"需要人工确认"的信息类 Finding，增加噪音。
- **审查深度有限:** 由于缺乏全局视图，难以发现涉及多个文件的复杂问题，例如：
  - API 接口变更导致的不一致。
  - 跨模块的逻辑错误。
  - 重构引入的潜在风险。
  - 架构符合性问题。

## 方案二：改进后的 Agent 设计方案 (上下文感知与深度分析)

为了克服原始设计的局限性，我们提出了一个更先进的设计方案。

### 核心理念

- 从"单文件 Diff 聚合"转向**"上下文感知、多阶段、深度分析"**。
- 关键在于引入对代码**依赖关系**和**变更影响域**的理解，并在整个流程中利用这个上下文信息。

### 关键技术：代码依赖图构建

- **基础:** 实现更深层次分析的基础是构建代码依赖图。
- **方法:** 通过对源代码进行**静态分析 (Static Analysis)**，通常是解析代码的抽象语法树 (AST)，识别文件间的导入关系、函数/方法调用、类继承/实例化等。
- **实现:**
  - 需要访问源代码。
  - **强烈建议**使用 **GitHub Actions** 在 Runner 环境中检出代码并运行静态分析工具。这避免了在 Code Review 系统本地 Clone 大型仓库的需要，同时能利用强大的标准分析库。
  - 分析工具（如 `dependency-cruiser` for JS/TS, `pydeps` for Python）生成依赖图数据（如 JSON 格式）。

### 架构与流程 (多阶段)

1.  **依赖分析阶段 (Input Processing & Initial Analysis):**
    - 获取 PR 信息和变更文件。
    - **构建代码依赖图** (通过 GitHub Action 或其他方式)。
    - 识别变更的直接和间接**影响域**。
2.  **上下文增强的文件审查阶段 (Context-Aware File Review):**
    - 审查 Agent (改进版的 `github-diff-review` 或新 Agent) 接收文件 Diff。
    - **关键:** 同时接收来自第一阶段的相关**跨文件上下文信息** (例如，被调用函数的签名、修改函数的调用点代码片段)。
    - Agent 利用这些上下文进行更准确的分析，减少猜测。
3.  **跨文件一致性与综合阶段 (Cross-File Consistency & Synthesis):**
    - 专门的 Agent 或逻辑负责整合所有文件级 Findings。
    - **利用依赖图**进行全局检查：
      - API 签名一致性。
      - 跨文件逻辑链验证。
    - 合并或消除基于相同底层原因的冗余 Findings。
    - 进行更准确的风险评估。
4.  **报告生成阶段 (Report Generation):**
    - 生成综合报告，不仅包含文件级问题，还明确指出**跨文件问题**和整体风险评估。

### 主要优势

- **理解变更的真实影响:** 能够评估修改对整个代码库的潜在影响范围。
- **深度和准确性:** 可以发现原始方案无法识别的跨文件问题（如 API 不一致、逻辑断裂），审查结果更准确，误报漏报更少。
- **上下文感知审查:** 文件级审查利用了更丰富的上下文，判断更可靠。
- **更智能的建议:** 能够提供更高层次的反馈，例如指出需要特别关注的交互点或风险区域。
- **设计潜力:** 更容易扩展以支持更高级的功能，如可配置规则引擎、基于反馈的学习、更深入的架构检查等。

### 实现考虑

- 需要引入**静态分析**能力来构建依赖图。
- 推荐使用 **GitHub Actions** 在代码仓库的上下文中执行依赖图构建，并将结果作为产物传递给 Code Review 系统。
- 需要设计和实现更复杂的 Agent 交互逻辑和跨文件分析模块。

## 总结对比

| 特性 / Feature     | 方案一：原始设计      | 方案二：改进设计 (上下文感知)     |
| :----------------- | :-------------------- | :-------------------------------- |
| **核心方法**       | 单文件 Diff 聚合      | 上下文感知 + 依赖图分析           |
| **跨文件上下文**   | 无                    | 通过依赖图提供                    |
| **依赖图构建**     | 否                    | **是 (核心步骤, 推荐 Actions)**   |
| **审查深度**       | 浅 (主要限于文件内部) | 深 (覆盖跨文件交互)               |
| **API 一致性检查** | 否                    | 是                                |
| **全局影响评估**   | 弱                    | 强                                |
| **结果准确性**     | 有限, 可能有误报/漏报 | 更高                              |
| **实现复杂度**     | 相对较低              | 更高 (需集成依赖分析与多阶段流程) |
| **对代码理解程度** | 低                    | 高                                |
