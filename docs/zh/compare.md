**核心目标：** 不再孤立地审查单个文件变更，而是理解变更在整个代码库中的**上下文**和**潜在影响**，从而提供更深入、更准确的审查意见。

**完整流程：**

1.  **触发 (Trigger):**

    - 开发者向代码仓库提交 Pull Request (PR) 或更新现有 PR。
    - GitHub (或类似平台) 触发一个事件 (如 `pull_request.opened`, `pull_request.synchronize`)。

2.  **准备阶段 (Preparation - 由 GitHub Actions 自动化):**

    - 与 PR 事件关联的 **GitHub Action** 自动运行。
    - Action **检出** PR 分支的最新代码。
    - Action 运行**静态分析工具** (例如 `dependency-cruiser` for JS/TS, `pydeps` for Python)。
    - 该工具分析代码，生成**文件级别的代码依赖图** (通常是 JSON 格式)，描述文件之间的导入/依赖关系。
    - Action 将生成的依赖图 JSON 文件作为**产物 (Artifact)** 上传。

3.  **启动与协调 (Initiation & Orchestration - 由入口服务处理):**

    - Code Review 系统的**入口服务**接收到来自 GitHub 的 Webhook 事件。
    - 入口服务调用 GitHub API 获取 PR 的详细信息 (变更了哪些文件、PR 描述等)。
    - 入口服务**下载**之前 GitHub Action 生成的**依赖图 JSON 产物**。

4.  **依赖分析与影响域确定 (Dependency Analysis & Impact Scope - 由依赖分析服务处理):**

    - **输入:** PR 变更的文件列表 和 下载的依赖图 JSON。
    - **核心处理:**
      - 服务加载并解析依赖图。
      - 对于 PR 中**每一个变更的文件**，利用依赖图查找：
        - **直接依赖**这个变更文件的其他文件 (Downstream Dependents)。
        - (可选) 这个变更文件**直接依赖**的其他文件 (Upstream Dependencies)。
        - (可选，更复杂) 传递性地查找间接依赖的文件。
      - **定义“审查影响域”:** 确定哪些文件需要被审查。这个范围**至少**包括：
        - 所有 PR 中**直接变更**的文件。
        - 所有**直接依赖**这些变更文件的文件。 (这是关键，扩大了审查范围)
        - 可以根据策略决定是否包含间接依赖或被依赖的文件。
    - **输出:** 一个明确的**需要审查的文件列表** (即影响域列表) 和完整的依赖图数据。

5.  **任务分发与上下文注入 (Task Distribution & Context Injection - 由任务分发器处理):**

    - 为影响域列表中的**每一个文件**创建一个独立的审查任务。
    - **关键步骤:** 为每个任务准备**上下文信息**。基于文件级依赖图，这个上下文主要是：
      - 告知 Agent：“你正在审查的文件 X，它依赖于文件 Y、Z，同时被文件 P、Q 依赖”。
    - 将任务 (包含文件路径、代码 Diff、以及上述文件级上下文信息) 分发给审查 Agent (通常通过消息队列或直接调用)。

6.  **上下文感知的文件审查 (Context-Aware File Review - 由审查 Agent 执行):**

    - 审查 Agent (可以有多个实例并行处理) 接收任务。
    - 获取对应文件的完整内容和代码 Diff。
    - **核心差异:** Agent 在分析 Diff 时，会**利用接收到的上下文信息**。例如，如果知道文件 X 被文件 P 依赖，Agent 会特别关注文件 X 中导出给 P 使用的部分的修改。
    - 执行代码分析，识别潜在问题 (逻辑错误、风格问题、安全隐患等)，生成初步的 Findings。
    - 对于那些可能与上下文文件中提到的接口相关的 Findings，可以进行**特殊标记**或提高优先级。
    - **输出:** 结构化的 Findings 列表 (每个 Finding 包含文件、行号、描述、严重性、类别，以及可能的上下文相关标记)。

7.  **跨文件综合与风险评估 (Cross-File Synthesis & Risk Assessment - 由结果聚合服务处理):**

    - **输入:** 所有审查 Agent 返回的 Findings 列表，以及完整的依赖图。
    - **核心处理:**
      - 聚合所有 Findings。
      - **利用依赖图进行全局分析:**
        - 识别**相互依赖**的文件中是否出现了关联的 Findings (例如，A 文件修改 API，依赖 A 的 B 文件报错)。
        - 尝试基于文件依赖关系**链接或合并**看似独立但根源相同的 Findings。
        - 结合文件在依赖图中的重要性 (如被多少文件依赖) 和 Findings 的严重性，进行更准确的**风险评估**。
    - **输出:** 经过整理、去重、关联、并带有风险评估的最终 Findings 列表。

8.  **报告生成与交付 (Report Generation & Delivery - 由报告生成服务处理):**
    - 将最终的 Findings 列表格式化成易于阅读的报告 (例如 Markdown 格式)。
    - 报告中应清晰地区分**文件内问题**和**潜在的跨文件关联问题**。
    - (可选) 调用平台 API (如 GitHub API) 将报告作为评论发布到 PR 上。

**总结这个思路的关键优势：**

- **超越单文件:** 不再局限于单个文件的改动，而是考虑其在系统中的位置和联系。
- **上下文驱动:** 利用依赖关系提供更丰富的上下文，指导审查过程，减少猜测和误报。
- **影响域识别:** 能识别出未直接修改但可能受影响的文件，提前暴露风险。
- **深度分析潜力:** 为实现更复杂的跨文件逻辑检查、API 一致性验证打下基础（尤其是在未来演进到符号级依赖图时）。

这个流程虽然比原始方案更复杂，但通过引入对代码结构的理解，旨在显著提升自动化代码审查的深度和有效性。
