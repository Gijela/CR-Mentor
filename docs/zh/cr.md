# CR-Mentor 代码审查方案五步流程梳理

## 1. 获取Diff信息

**目标**：收集PR的代码变更内容和元数据

**实现方式**：
- 通过GitHub API获取PR的差异信息（文件列表、具体变更内容、提交信息）
- 保存为DiffInfo数据结构，包含files和commits两部分

**关键功能**：
- 不仅获取变更代码，还获取提交信息以了解变更意图
- 为后续分析提供完整上下文
- 处理多种文件格式和变更类型

**数据输出**：
```
{
  files: [变更文件列表及其patch内容],
  commits: [提交信息列表]
}
```

## 2. 处理Diff实体

**目标**：从变更内容中提取关键实体，筛选重要变更

**实现方式**：
- 将变更内容分组，防止超出模型上下文限制
- 使用LLM处理每组内容，提取关键实体（函数名、类名、变量名等）
- 过滤不重要的小变更，保留重要变更
- 提取commit信息摘要

**关键功能**：
- 智能区分重要和次要变更，专注有意义的代码修改
- 提取实体为后续构建知识图谱做准备
- 计算变更文件的共同根目录

**数据输出**：
```
{
  entityList: [{ file_path: "路径", entities: ["实体1", "实体2", ...] }, ...],
  filteredSummary: "过滤后的摘要",
  miniCommonRoot: "共同根目录",
  targetPaths: ["目标路径1", "目标路径2", ...],
  commitsMsg: "提交信息摘要"
}
```

## 3. 构建代码知识图谱

**目标**：创建代码元素之间的关系网络，形成代码知识图谱

**实现方式**：
- 分析代码结构，识别函数、类、接口等元素
- 建立元素之间的关系（调用、继承、实现等）
- 生成节点（代码元素）和边（关系）组成的知识图谱
- 基于依赖关系划分功能模块

**关键功能**：
- 构建代码结构的图形表示
- 识别跨文件关系和依赖
- 通过图算法划分功能模块
- 保存实现细节供后续参考

**数据结构**：
```
{
  nodes: [{ id, name, type, filePath, location, implementation, ... }, ...],
  edges: [{ source, target, type, properties }, ...]
}
```

## 4. 生成上下文列表

**目标**：为每个功能模块整合相关上下文信息

**实现方式**：
- 基于第二步的实体列表，从代码知识图谱中检索相关上下文
- 根据功能模块划分变更
- 整合diff patch和实体上下文，形成完整上下文信息
- 为每个模块生成可提供给大模型的prompt

**关键功能**：
- 结合不同信息源（代码变更、实体关系、提交信息）
- 构建结构化上下文
- 按模块划分复杂变更
- 准备模型输入

**输出格式**：
```
[
  `## 本次PR的所有模块的commits message信息
   ${提交信息}
   
   ## 本模块的所有diff patch信息
   ${patch内容列表}
   
   ## 本模块使用到的关键信息
   ${相关实体上下文}`,
  
  // 其他模块的上下文...
]
```

## 5. 执行代码审查

**目标**：基于完整上下文，对代码变更进行深入审查并生成反馈

**实现方式**：
- 将上下文信息提交给LLM进行分析
- 为每个模块生成评审结果
- 合并各模块结果生成整体评审
- 发布评审结果到GitHub PR评论中

**关键功能**：
- 使用专门设计的提示词指导LLM进行审查
- 生成三类审查结果：
  1. walkthrough（代码演练）：高层次变更总结
  2. changes（变更说明）：文件及其变更的表格
  3. sequenceDiagram（时序图）：代码逻辑的可视化表示
- 识别严重问题并生成suggestions（建议）
- 自动发布总结和评论到GitHub

**输出结果**：
```
{
  walkthrough: "整体变更总结",
  changes: "变更文件的表格展示",
  sequenceDiagram: "mermaid格式的时序图",
  suggestions: [
    { file_path: "文件路径", comment: "评论内容" },
    // 其他建议...
  ]
}
```

## 五个步骤的关联与价值

### 数据流转关系

1. 第1步的diff信息 → 第2步提取实体
2. 第2步的实体列表 → 第3步构建知识图谱 + 第4步检索上下文
3. 第3步的知识图谱 → 第4步检索相关实体上下文
4. 第4步的上下文列表 → 第5步执行代码审查
5. 第5步生成审查结果 → 发布到GitHub

### 核心价值

1. **全面理解代码上下文**：通过五步流程，从原始变更到完整上下文，再到智能分析，实现对代码的全面理解
2. **模块化处理**：将变更按功能模块划分，确保审查的连贯性和完整性
3. **知识图谱驱动**：以代码知识图谱为核心数据结构，实现深度代码理解
4. **精准评审反馈**：基于完整上下文，生成高质量、针对性强的审查意见
5. **自动化工作流**：全流程自动化，从PR创建到评审结果发布

这五个步骤形成了一个完整的工作流程，从原始数据获取、实体提取、知识构建、上下文整合到最终审查，每一步都为下一步提供必要输入，最终形成高质量的代码审查结果。
