# RAG 文档问答系统服务端

这是一个基于 RAG (检索增强生成) 架构的文档问答系统服务端，支持文档上传、向量化存储和智能问答功能。

## 功能特点

- 支持 txt、md 格式文档上传
- 使用 Supabase 向量数据库进行持久化存储
- 基于 DeepSeek-V2.5 大语言模型
- 使用 bge-large-zh-v1.5 进行文本向量化
- 支持文档分块和上下文重叠
- RESTful API 接口
- 完整的日志记录和错误处理

## 技术栈

- Node.js + TypeScript
- Koa.js Web 框架
- LangChain.js
- Supabase Vector Store
- Winston 日志系统

## 安装

1. 克隆项目并安装依赖：

```bash
git clone [<repository-url>](https://github.com/Gijela/CR-Mentor)
pnpm run install:server
```

2. 配置环境变量，创建 `.env` 文件：

```env
OPENAI_API_KEY=your_api_key
OPENAI_API_BASE=your_api_base_url
SUPABASE_URL=your_supabase_url
SUPABASE_KEY=your_supabase_key
```

3. 在 Supabase 中创建向量表和搜索函数：

```sql
-- 启用向量扩展
create extension if not exists vector;

-- 创建向量表
create table documents2 (
  id bigint generated by default as identity primary key,
  content text,
  metadata jsonb,
  embedding vector(1536)
);

-- 创建向量搜索函数
create function match_fn_cr(query_embedding vector(1536), match_count int default 5)
returns table (
  id bigint,
  content text,
  metadata jsonb,
  similarity float
)
language plpgsql
as $$
begin
  return query
  select
    id,
    content,
    metadata,
    1 - (documents2.embedding <=> query_embedding) as similarity
  from documents2
  order by documents2.embedding <=> query_embedding
  limit match_count;
end;
$$;

-- 创建向量索引
create index on documents2 
using ivfflat (embedding vector_cosine_ops)
with (lists = 100);
```

## 启动服务

开发环境：
```bash
pnpm run start:server
```

服务默认运行在 8000 端口。

## API 接口

### 1. 文档上传

```bash
curl -X POST http://localhost:8000/upload \
  -H "Content-Type: multipart/form-data" \
  -F "file=@packages/server/test/b.md"
```

支持的文件格式：.txt, .md，最大文件大小：10MB

返回结果：

```json
{
  "message": "文档处理完成",
  "filename": "b.md"
}
```

### 2. 问答查询

```bash
curl -X POST http://localhost:8000/query \
  -H "Content-Type: application/json" \
  -d '{
    "question": "什么是 RAG?"
  }'
```

返回结果：

```json
{
  "answer":"我不清楚什么是 RAG。根据提供的上下文，没有关于 RAG 的信息。",
  "source_documents": [
    {
      "pageContent":"## 测试\n一些文字、\n都是规范",
      "metadata":{
        "loc":{ "lines": { "to": 3, "from": 1 } },
        "source":"uploads/9ca000efa28d6f18c4b3158fee36f687"
      }
    },
    {
      "pageContent":"## 测试\n一些文字、\n都是规范",
      "metadata":{
        "loc":{ "lines": { "to": 3, "from": 1 } },
        "source":"uploads/a70ddfd53f9d9861060cbc85bffddd94"
      }
    }
  ]
}
```

### 3. 健康检查

```bash
curl -X GET http://localhost:8000/health
```

返回结果：

```json
{
  "status":"ok",
  "components":{
    "vectorStore":true,
    "embeddings":true,
    "llm":true
  }
}
```

## 核心模块

### DocumentProcessor
处理文档加载和分块：

```typescript
class DocumentProcessor {
  private textSplitter: RecursiveCharacterTextSplitter;

  constructor() {
    this.textSplitter = new RecursiveCharacterTextSplitter({
      chunkSize: 1000,
      chunkOverlap: 200
    });
  }

  async loadDocument(input: string | { text: string; metadata?: Record<string, any> }) {
    try {
      if (typeof input === 'string') {
        return [new Document({ pageContent: input })];
      }
      return [new Document({ 
        pageContent: input.text,
        metadata: input.metadata || {}
      })];
    } catch (error) {
      throw new Error(`加载文档失败: ${error}`);
    }
  }

  async splitDocuments(documents: Document[]): Promise<Document[]> {
    return await this.textSplitter.splitDocuments(documents);
  }
}
```


### VectorStore
管理向量存储：

```typescript
class VectorStore {
  public vectorstore: SupabaseVectorStore | null = null;
  private embeddings: OpenAIEmbeddings;
  private supabaseClient;

  constructor(embeddings: OpenAIEmbeddings) {
    this.embeddings = embeddings;
    this.supabaseClient = createClient(config.SUPABASE_URL, config.SUPABASE_KEY);
  }

  async createVectorStore(documents: Document[], metadata: StoreMetadata) {
    try {
      const docsWithMetadata = documents.map(doc => {
        doc.metadata = {
          ...doc.metadata,
          sourceFile: metadata.sourceFile,
          sourceUrl: metadata.sourceUrl
        };
        return doc;
      });

      this.vectorstore = await SupabaseVectorStore.fromDocuments(
        docsWithMetadata,
        this.embeddings,
        {
          client: this.supabaseClient,
          tableName: 'documents2',
          queryName: 'match_fn_cr'
        }
      );

      logger.info(`向量存储创建成功，文档数量: ${documents.length}`);
      return this.vectorstore;
    } catch (error) {
      logger.error('创建向量存储失败:', error);
      throw new Error(`创建向量存储失败: ${error}`);
    }
  }
}
```


## 配置说明

系统配置在 `config/settings.ts` 中管理：

```typescript
const config: Config = {
  OPENAI_API_KEY: process.env.OPENAI_API_KEY || '',
  OPENAI_API_BASE: process.env.OPENAI_API_BASE || '',
  SUPABASE_URL: process.env.SUPABASE_URL || '',
  SUPABASE_KEY: process.env.SUPABASE_KEY || '',
  COLLECTION_NAME: 'documents2'
};
```


## 日志

- 错误日志：`error.log`
- 综合日志：`combined.log`
- 控制台输出

## 注意事项

1. 确保 Supabase 项目已正确配置并启用向量扩展
2. 环境变量必须完整配置
3. 服务启动前需要创建必要的数据库表和函数
4. 建议在生产环境中配置适当的安全措施

## 开发计划

- [ ] 添加用户认证
- [ ] 支持更多文档格式
- [ ] 添加文档管理功能
- [ ] 优化向量检索性能
- [ ] 添加批量导入功能

## License

MIT