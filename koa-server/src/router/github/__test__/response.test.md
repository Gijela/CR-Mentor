## 测试返回结果
--- 开始 GitHub API 接口测试 ---

[测试] 调用 analyzeUserActivity 接口...
测试请求体: {
  "repositories": [
    {
      "owner": "gijela",
      "repoName": "cr-mentor",
      "branchName": "main"
    }
  ],
  "timeRange": {
    "since": "2025-05-01T00:00:00Z",
    "until": "2025-05-02T00:00:00Z"
  },
  "targetUsername": "Gijela"
}
正在发送请求到: http://localhost:4000/github/analyzeUserActivity
response状态: 200 OK

--- analyzeUserActivity API 响应 ---
状态: 200
响应数据:
[
  {
    "owner": "gijela",
    "repoName": "cr-mentor",
    "branchName": "main",
    "commits": [
      {
        "sha": "c575764539174ca5ec8926fec00fa3d98131f060",
        "message": "refactor(koa-server): improve PR review process and rename prompt files\n\n- Rename system-prompt.ts to patch-summary.ts for better clarity\n- Add new pr-summary.ts file for generating PR summary prompt\n- Update prompt content to provide more detailed instructions for reviewers\n- Modify controller and router to use new prompt files\n- Enhance error handling and response structure in deepwiki router",
        "date": "2025-05-01T16:17:43Z",
        "files": [
          {
            "filename": "koa-server/src/app/prompt/github/patch-summary.ts",
            "status": "renamed",
            "patch": "@@ -1,5 +1,4 @@\n-\n-export const buildSystemPrompt = (prTitle: string, prDesc: string, commitMessages: string[]) => {\n+export const buildPatchSummaryPrompt = (prTitle: string, prDesc: string, commitMessages: string[]) => {\n   return `\n # Character Description\n You are an experienced Code Reviewer, specializing in identifying critical functional issues, logical errors, vulnerabilities, and major performance problems in Pull Requests (PRs).\n@@ -22,7 +21,7 @@ You have two Pull Request review task with basic information:\n ## Task 1: Summarize the Pull Request\n Provider your response in markdown with the following content. \n   - **Walkthrough**:  A high-level summary of the overall change instead of specific files within 80 words.\n-  - **Changes**: A markdown table of files and their summaries. Group files with similar changes together into a single row to save space.\n+  - **Changes**: A markdown table of files、change type(feat, fix, refactor, perf, test, chore, style, ci, docs, revert) and their summaries. Group files with similar changes together into a single row to save space.\n \n ### Additional Instructions:\n - Carefully check the markdown format. If there are any errors, fix them before providing the final result."
          },
          {
            "filename": "koa-server/src/app/prompt/github/pr-summary.ts",
            "status": "added",
            "patch": "@@ -0,0 +1,36 @@\n+export const buildPrSummaryPrompt = (deletedFiles: string[], chatResults: string[]) => `\n+Hello, in this session, we will focus on analyzing a specific Pull Request (PR). \n+Your primary task is to process the independent review results for a series of different patch sections of the PR that I will provide next.\n+You need to merge these results based on the overall repository analysis and summarize them into a single, final report covering the entire PR. \n+Please ensure that the format and structure of the final report are consistent with the original results.\n+After you complete and generate this consolidated report, please be prepared to answer any follow-up questions I might have about this PR.\n+At that time, you can use the original review results I provided and the summary report you generated as the basis for our discussion.\n+\n+**Important Requirement:**\n+- The following files were deleted in this Pull Request. You **MUST** include these deleted files in the final \"Changes\" table along with the other modified files.\n+-  Group files with similar changes together into a single row to save space as far as possible.\n+-  If the \"Changes\" table becomes very long, especially with many deleted files, consider merging similar entries for brevity.\n+\n+Deleted Files:\n+${deletedFiles.map(file => `- ${file}`).join('\\n')}\\n\\n\n+\n+**Merging Suggestion:**\n+- If the \"Changes\" table becomes very long, especially with many deleted files, consider merging similar entries for brevity. \n+- For example, you could group multiple deleted files under a single entry like \"Multiple configuration files deleted\" or similar, if appropriate. \n+- Use your best judgment to keep the table informative yet concise.\n+- During the merge process, you must keep the path and line for each issue found by the code review\n+\n+**Visual Aids:**\n+To further improve clarity for the reviewer, consider incorporating simple visual aids or references that show **before-and-after comparisons** reflecting the PR's changes. Focus on diagrams that clearly illustrate the impact of the PR:\n+*   **Module/Component Impact Comparison:** Show how module relationships or dependencies change.\n+*   **Structural Comparison:** For significant refactoring or architectural changes, illustrate the structural differences (e.g., using simplified architecture diagrams).\n+*   **Flow/Sequence Diagram Comparison:** If key processes or interactions are altered, compare the sequence diagrams before and after the change.\n+*   **Class Diagram Comparison:** If core class structures are modified, show the differences.\n+*   **UI Comparison:** For visual changes, reference or include before-and-after screenshots/mockups.\n+Use your judgment on whether a visual aid adds significant value and can be concisely represented or referenced. The goal is to clearly show the *change* introduced by the PR.\n+\n+Please now merge the review summaries of the multiple patches provided below AND incorporate the deleted files list above into a single, \n+complete PR summary report, ensuring the \"Changes\" table includes all modified AND deleted files.\\n\\n\n+Patch Summaries to Merge:\n+${chatResults}\n+`\n\\ No newline at end of file"
          },
          {
            "filename": "koa-server/src/controller/github/index.ts",
            "status": "modified",
            "patch": "@@ -5,7 +5,7 @@ import logger from \"@/utils/logger\"\n import { formatAndGroupDiff } from \"@/lib/groupDiff\"\n import { EDIT_TYPE } from \"@/lib/groupDiff/types\"\n import { FileObject } from \"./types\"\n-import { buildSystemPrompt } from \"@/app/prompt/github/system-prompt\"\n+import { buildPatchSummaryPrompt } from \"@/app/prompt/github/patch-summary\"\n \n // 根据 githubName 创建 token\n export const createToken = async (ctx: Koa.Context) => {\n@@ -225,7 +225,7 @@ export const getDiffsDetails = async (ctx: Koa.Context) => {\n     const { files, commits }: { files: FileObject[], commits: any[] } = await response.json()\n     const commitMessages = commits.map(commit => commit.commit.message)\n     const CALL_DEEPWIKI_REPO = 'Based on the current repository information, please play the following role to help me review the code, before opening the diff code review, I need you to clarify your task, after you correctly clarify, I will provide you with the diff code.'\n-    const systemPrompt = CALL_DEEPWIKI_REPO + buildSystemPrompt(prTitle, prDesc, commitMessages)\n+    const systemPrompt = CALL_DEEPWIKI_REPO + buildPatchSummaryPrompt(prTitle, prDesc, commitMessages)\n \n     // 4. 智能分组 diff\n     const diffFiles = files.map(file => ({\n@@ -235,7 +235,7 @@ export const getDiffsDetails = async (ctx: Koa.Context) => {\n     const result = formatAndGroupDiff(modelMaxToken, diffFiles, systemPrompt);\n \n     ctx.status = 200\n-    ctx.body = { success: true, data: result, s: result.patches[0], systemPrompt }\n+    ctx.body = { success: true, data: result, systemPrompt }\n   } catch (error) {\n     logger.error(\"🚀 ~ getDiffsDetails ~ error:\", error)\n     ctx.status = 500"
          },
          {
            "filename": "koa-server/src/router/deepwiki/index.ts",
            "status": "modified",
            "patch": "@@ -4,6 +4,7 @@ const router = new Router({ prefix: \"/deepwiki\" })\n \n import { sendMessage, pollingResponse, generateUUID } from \"@/controller/deepwiki/utils\"\n import { HandleLargeDiffResult } from \"@/lib/groupDiff/types\"\n+import { buildPrSummaryPrompt } from \"@/app/prompt/github/pr-summary\";\n \n // // 发送消息\n // router.post(\"/sendMessage\", async (ctx) => {\n@@ -39,28 +40,28 @@ async function initializeSessionWithSystemPrompt(\n   systemPrompt: string,\n   query_id: string,\n   logPrefix: string = \"\" // 可选的日志前缀，用于区分调用场景\n-): Promise<boolean> {\n+): Promise<{ success: boolean, message: string, content: string, error?: any }> {\n   console.log(`${logPrefix}🚀 ~ 使用 Query ID (${query_id}) 发送 System Prompt...`);\n   try {\n     const sendResult = await sendMessage(repo_name, systemPrompt, query_id);\n-    if (!sendResult) {\n+    if (!sendResult || !sendResult?.status) {\n       console.error(`${logPrefix}🚨 ~ 发送 System Prompt (Query ID: ${query_id}) 失败: sendMessage returned falsy.`);\n-      return false; // 发送失败\n+      return { success: false, message: 'failed to send message', content: '' }; // 发送失败\n     }\n     console.log(`${logPrefix}   ~ System Prompt (Query ID: ${query_id}) 发送成功, 开始轮询...`);\n \n-    const pollingResult = await pollingResponse(query_id);\n-    if (!pollingResult) {\n+    const { isDone, content } = await pollingResponse(query_id);\n+    if (!isDone) {\n       console.warn(`${logPrefix}⚠️ ~ 轮询 System Prompt (Query ID: ${query_id}) 失败: pollingResponse returned falsy.`);\n       // 注意：即使轮询失败，对于重试场景，我们可能仍希望继续。\n       // 但对于初始场景，这通常表示失败。调用者需要根据返回值决定如何处理。\n-      return false; // 轮询失败/无结果\n+      return { success: false, message: 'failed to polling response', content: '' }; // 轮询失败/无结果\n     }\n     console.log(`${logPrefix}   ~ System Prompt (Query ID: ${query_id}) 处理完成.`);\n-    return true; // 成功\n+    return { success: true, message: 'success', content }; // 成功\n   } catch (error: any) {\n     console.error(`${logPrefix}🚨 ~ 处理 System Prompt (Query ID: ${query_id}) 时发生异常:`, error);\n-    return false; // 发生异常\n+    return { success: false, message: 'failed to initialize session with system prompt', content: '', error }; // 发生异常\n   }\n }\n \n@@ -112,7 +113,7 @@ router.post(\"/getResult\", async (ctx) => {\n     console.log(\"🚀 ~ 获取 diffs & system prompt 成功，共\", data.patches.length, \"个 patches\");\n \n     // 1.5 使用初始 Query ID 初始化会话\n-    const initialSessionOk = await initializeSessionWithSystemPrompt(repo_name, systemPrompt, currentQueryId, \"[初始会话] \");\n+    const { success: initialSessionOk } = await initializeSessionWithSystemPrompt(repo_name, systemPrompt, currentQueryId, \"[初始会话] \");\n     if (!initialSessionOk) {\n       console.error(\"🚨 ~ 初始化会话失败 (发送或轮询初始 System Prompt 出错).\");\n       ctx.status = 500;\n@@ -126,7 +127,7 @@ router.post(\"/getResult\", async (ctx) => {\n \n     // 2. 遍历 patches，依次发送消息并获取结果 (允许重试)\n     console.log(\"🚀 ~ 开始处理 Patches...\");\n-    const CALL_PATCH_REVIEW = 'Please follow the requirements to REVIEW the multiple file diff code provided below.'\n+    const CALL_PATCH_REVIEW = 'Please follow the requirements to review the multiple file diff code provided below.'\n     for (let i = 0; i < data.patches.length; i++) {\n       const patch = CALL_PATCH_REVIEW + data.patches[i];\n       const currentAttempt = (retryCounts[i] || 0) + 1;\n@@ -168,7 +169,7 @@ router.post(\"/getResult\", async (ctx) => {\n           console.log(`   ~ 创建新的 Query ID: ${currentQueryId} 用于重试 Patch ${i + 1} (旧 ID: ${previousQueryId})`)\n \n           // === 使用新 Query ID 初始化会话 (用于重试) ===\n-          const retrySessionOk = await initializeSessionWithSystemPrompt(repo_name, systemPrompt, currentQueryId, \"[重试会话] \");\n+          const { success: retrySessionOk } = await initializeSessionWithSystemPrompt(repo_name, systemPrompt, currentQueryId, \"[重试会话] \");\n           if (!retrySessionOk) {\n             // 即使 System Prompt 初始化失败，仍然尝试发送 patch\n             console.warn(`   ~ [重试会话] 初始化失败，但仍将继续尝试发送 Patch ${i + 1} (Query ID: ${currentQueryId})`);\n@@ -189,12 +190,26 @@ router.post(\"/getResult\", async (ctx) => {\n \n     // 3. 所有 patches 处理完成 (可能部分跳过)，返回聚合结果和所有 query_id\n     console.log(\"✅ ~ 所有 Patches 处理完成\")\n+\n+    // 4. 生成 summary\n+    const summaryQueryId = generateUUID()\n+    const summaryPrompt = buildPrSummaryPrompt(data.deletedFiles, chatResults)\n+\n+    const { success: finalSessionOk, content: summaryContent, error: summaryError } = await initializeSessionWithSystemPrompt(repo_name, summaryPrompt, summaryQueryId, \"[summary] \");\n+    if (!finalSessionOk) {\n+      console.error(\"🚨 ~ 初始化会话失败 (发送或轮询初始 System Prompt 出错).\");\n+      ctx.status = 500;\n+      ctx.body = { success: false, message: \"Failed to initialize session with system prompt.\", queryIds: queryIdsUsed, summaryQueryId, summaryError };\n+      return; // 中止处理\n+    }\n     ctx.status = 200\n     ctx.body = {\n       success: true,\n       data: {\n         chatResults: chatResults, // 只包含成功获取结果的 patch\n-        queryIds: queryIdsUsed    // 包含所有尝试过的 queryId\n+        chatQueryIds: queryIdsUsed,    // 包含所有尝试过的 queryId\n+        summaryQueryId,\n+        summaryContent\n       }\n     }\n   } catch (error: any) {"
          }
        ]
      },
      {
        "sha": "e748de4110ba683d5c88efd12d350eb243b637df",
        "message": "refactor(koa-server): improve system prompt handling and patch processing\n\n- Update system prompt structure and content\n- Add initialization step with system prompt before patch review\n- Improve error handling and logging throughout the process\n- Refactor patch processing loop for better retry management\n- Update API response structure for consistency",
        "date": "2025-05-01T12:03:37Z",
        "files": [
          {
            "filename": "koa-server/src/app/prompt/github/system-prompt.ts",
            "status": "modified",
            "patch": "@@ -1,61 +1,64 @@\n \n-export const buildSystemPrompt = (prTitle, prDesc, commitMessages) => {\n+export const buildSystemPrompt = (prTitle: string, prDesc: string, commitMessages: string[]) => {\n   return `\n-    # Character Description\n-    You are an experienced Code Reviewer, specializing in identifying critical functional issues, logical errors, vulnerabilities, and major performance problems in Pull Requests (PRs).\n-\n-    # Skills Description\n-    ## Skill 1: Pull Request Summarize\n-    You excel at analyzing users' code changes and generating precise summaries.\n-    You are focused on highlighting critical code changes that may lead to severe issues or errors.\n-\n-    ## Skill 2: Code Review\n-    You are an AI Assistant specialized in reviewing pull requests with a focus on critical issues.\n-\n-    # Task\n-    You have two Pull Request review task with basic information:\n-\n-    ## Task 1: Summarize the Pull Request\n-    Provider your response in markdown with the following content. \n-      - **Walkthrough**:  A high-level summary of the overall change instead of specific files within 80 words.\n-      - **Changes**: A markdown table of files and their summaries. Group files with similar changes together into a single row to save space.\n-\n-    ### Additional Instructions:\n-    - Carefully check the markdown format. If there are any errors, fix them before providing the final result.\n-    - Respond in the language of the PR title and content (e.g., if the title/content is in Chinese, reply in Chinese; if it's in English, reply in English).\n-    - At the end of the conversation, be sure to include the following wording and adhere to the language used in previous conversations:\n-\n-    ## Task 2: Code Review\n-\n-    Review the code diff exclusively for critical logical, functional, or security errors. Avoid any commentary unrelated to these areas, including documentation, stylistic changes, or minor issues.\n-\n-    ### Specific Instructions:\n-\n-    - Only the code diff is provided, but you need to review it in the context of the full repository codebase.\n-    - Make comments only on code introducing clear and critical functional or security errors.\n-    - Do not comment on documentation, style, accuracy of text, or minor refactoring changes.\n-    - If necessary, provide code examples only for addressing critical errors.\n-    - Adhere to language-specific coding conventions used in the PR.\n-    - Avoid providing suggestions related to code optimization or best practices (e.g., \"ensure\" or \"make sure\") unless they address critical errors.\n-    - Skip the task entirely if no critical errors are found in the code diff.\n-    - Upon completing the task, output strictly \"All task finished\", with no additional commentary.\n-\n-\n-    ### Input format\n-\n-    - The input format follows Github diff format with addition and subtraction of code.\n-    - The + sign means that code has been added.\n-    - The - sign means that code has been removed.\n-\n-    # Skip Task Whitelist\n-    **SKIP_KEYWORDS**: A list of keywords. If any of these keywords are present in the PR title or description, the corresponding task will be skipped.\n-    - Examples: \"skip\", \"ignore\", \"wip\", \"merge\", \"[skip ci]\"\n-    - If the draft flag is set to true, the task should be skipped.\n-\n-    # Constraints\n-    - Strictly avoid commenting on minor style inconsistencies, formatting issues, or changes that do not impact functionality.\n-    - Only flag code changes that introduce serious problems (logical errors, security vulnerabilities, typo or functionality-breaking bugs).\n-    - Respect the language of the PR’s title and description when providing summaries and comments (e.g., English or Chinese).\n+# Character Description\n+You are an experienced Code Reviewer, specializing in identifying critical functional issues, logical errors, vulnerabilities, and major performance problems in Pull Requests (PRs).\n+\n+# Skills Description\n+## Skill 1: Pull Request Summarize\n+You excel at analyzing users' code changes and generating precise summaries.\n+You are focused on highlighting critical code changes that may lead to severe issues or errors.\n+\n+## Skill 2: Code Review\n+You are an AI Assistant specialized in reviewing pull requests with a focus on critical issues.\n+\n+# Task\n+You have two Pull Request review task with basic information:\n+- **PR Title**: ${prTitle}\n+- **PR Description**: ${prDesc}\n+- **Commit Messages**: \n+  ${commitMessages.map(message => `- ${message}`).join(\"\\n\")}\n+\n+## Task 1: Summarize the Pull Request\n+Provider your response in markdown with the following content. \n+  - **Walkthrough**:  A high-level summary of the overall change instead of specific files within 80 words.\n+  - **Changes**: A markdown table of files and their summaries. Group files with similar changes together into a single row to save space.\n+\n+### Additional Instructions:\n+- Carefully check the markdown format. If there are any errors, fix them before providing the final result.\n+- Respond in the language of the PR title and content (e.g., if the title/content is in Chinese, reply in Chinese; if it's in English, reply in English).\n+- At the end of the conversation, be sure to include the following wording and adhere to the language used in previous conversations:\n+\n+## Task 2: Code Review\n+\n+Review the code diff exclusively for critical logical, functional, or security errors. Avoid any commentary unrelated to these areas, including documentation, stylistic changes, or minor issues.\n+\n+### Specific Instructions:\n+\n+- Only the code diff is provided, but you need to review it in the context of the full repository codebase.\n+- Make comments only on code introducing clear and critical functional or security errors.\n+- Do not comment on documentation, style, accuracy of text, or minor refactoring changes.\n+- If necessary, provide code examples only for addressing critical errors.\n+- Adhere to language-specific coding conventions used in the PR.\n+- Avoid providing suggestions related to code optimization or best practices (e.g., \"ensure\" or \"make sure\") unless they address critical errors.\n+- Skip the task entirely if no critical errors are found in the code diff.\n+- For every issue mentioned in a comment, the path and line must be provided.(path: The relative path of the file being reviewed. line: The line number in the pull request diff view to which the comment applies, not the line number in the original source file.)\n+\n+### Input format\n+\n+- The input format follows Github diff format with addition and subtraction of code.\n+- The + sign means that code has been added.\n+- The - sign means that code has been removed.\n+\n+# Skip Task Whitelist\n+**SKIP_KEYWORDS**: A list of keywords. If any of these keywords are present in the PR title or description, the corresponding task will be skipped.\n+- Examples: \"skip\", \"ignore\", \"wip\", \"merge\", \"[skip ci]\"\n+- If the draft flag is set to true, the task should be skipped.\n+\n+# Constraints\n+- Strictly avoid commenting on minor style inconsistencies, formatting issues, or changes that do not impact functionality.\n+- Only flag code changes that introduce serious problems (logical errors, security vulnerabilities, typo or functionality-breaking bugs).\n+- Respect the language of the PR’s title and description when providing summaries and comments (e.g., English or Chinese).\n `\n }\n "
          },
          {
            "filename": "koa-server/src/controller/github/index.ts",
            "status": "modified",
            "patch": "@@ -188,7 +188,7 @@ export const createPullRequest = async (ctx: Koa.Context) => {\n \n // 获取 diffs 详情\n export const getDiffsDetails = async (ctx: Koa.Context) => {\n-  const { prTitle, prDesc, githubName, compareUrl, baseLabel, headLabel, modelMaxToken = 100000 } = ctx.request.body as any\n+  const { prTitle, prDesc, githubName, compareUrl, baseLabel, headLabel, modelMaxToken = 25000 } = ctx.request.body as any\n \n   try {\n     // 1. 创建token\n@@ -224,7 +224,8 @@ export const getDiffsDetails = async (ctx: Koa.Context) => {\n     }\n     const { files, commits }: { files: FileObject[], commits: any[] } = await response.json()\n     const commitMessages = commits.map(commit => commit.commit.message)\n-    const systemPrompt = buildSystemPrompt(prTitle, prDesc, commitMessages)\n+    const CALL_DEEPWIKI_REPO = 'Based on the current repository information, please play the following role to help me review the code, before opening the diff code review, I need you to clarify your task, after you correctly clarify, I will provide you with the diff code.'\n+    const systemPrompt = CALL_DEEPWIKI_REPO + buildSystemPrompt(prTitle, prDesc, commitMessages)\n \n     // 4. 智能分组 diff\n     const diffFiles = files.map(file => ({\n@@ -234,7 +235,7 @@ export const getDiffsDetails = async (ctx: Koa.Context) => {\n     const result = formatAndGroupDiff(modelMaxToken, diffFiles, systemPrompt);\n \n     ctx.status = 200\n-    ctx.body = { success: true, data: result }\n+    ctx.body = { success: true, data: result, s: result.patches[0], systemPrompt }\n   } catch (error) {\n     logger.error(\"🚀 ~ getDiffsDetails ~ error:\", error)\n     ctx.status = 500"
          },
          {
            "filename": "koa-server/src/router/deepwiki/index.ts",
            "status": "modified",
            "patch": "@@ -33,6 +33,37 @@ import { HandleLargeDiffResult } from \"@/lib/groupDiff/types\"\n //   }\n // })\n \n+// 辅助函数：发送 System Prompt 并等待响应\n+async function initializeSessionWithSystemPrompt(\n+  repo_name: string,\n+  systemPrompt: string,\n+  query_id: string,\n+  logPrefix: string = \"\" // 可选的日志前缀，用于区分调用场景\n+): Promise<boolean> {\n+  console.log(`${logPrefix}🚀 ~ 使用 Query ID (${query_id}) 发送 System Prompt...`);\n+  try {\n+    const sendResult = await sendMessage(repo_name, systemPrompt, query_id);\n+    if (!sendResult) {\n+      console.error(`${logPrefix}🚨 ~ 发送 System Prompt (Query ID: ${query_id}) 失败: sendMessage returned falsy.`);\n+      return false; // 发送失败\n+    }\n+    console.log(`${logPrefix}   ~ System Prompt (Query ID: ${query_id}) 发送成功, 开始轮询...`);\n+\n+    const pollingResult = await pollingResponse(query_id);\n+    if (!pollingResult) {\n+      console.warn(`${logPrefix}⚠️ ~ 轮询 System Prompt (Query ID: ${query_id}) 失败: pollingResponse returned falsy.`);\n+      // 注意：即使轮询失败，对于重试场景，我们可能仍希望继续。\n+      // 但对于初始场景，这通常表示失败。调用者需要根据返回值决定如何处理。\n+      return false; // 轮询失败/无结果\n+    }\n+    console.log(`${logPrefix}   ~ System Prompt (Query ID: ${query_id}) 处理完成.`);\n+    return true; // 成功\n+  } catch (error: any) {\n+    console.error(`${logPrefix}🚨 ~ 处理 System Prompt (Query ID: ${query_id}) 时发生异常:`, error);\n+    return false; // 发生异常\n+  }\n+}\n+\n type GetResultBody = {\n   githubName: string\n   compareUrl: string\n@@ -56,7 +87,8 @@ router.post(\"/getResult\", async (ctx) => {\n   const retryCounts: { [key: number]: number } = {}; // 记录每个 patch 的重试次数\n \n   try {\n-    // 1. 获取 diffs & 合理分组 diffs\n+    // 1. 获取 diffs & systemPrompt\n+    console.log(\"🚀 ~ 开始获取 diff 详情和 system prompt...\");\n     const response = await fetch(`${process.env.SERVER_HOST}/github/getDiffsDetails`, {\n       method: \"POST\",\n       headers: { \"Content-Type\": \"application/json\" },\n@@ -70,37 +102,51 @@ router.post(\"/getResult\", async (ctx) => {\n       return;\n     }\n \n-    const { success, data } = (await response.json()) as { success: boolean, data: HandleLargeDiffResult }\n-    if (!success || !data || !Array.isArray(data.patches)) {\n-      console.error(\"Invalid diff details response:\", { success, data });\n+    const { success, data, systemPrompt } = (await response.json()) as { success: boolean, data: HandleLargeDiffResult, systemPrompt: string }\n+    if (!success || !data || !Array.isArray(data.patches) || !systemPrompt) {\n+      console.error(\"Invalid diff details response:\", { success, data, systemPrompt });\n       ctx.status = 500\n       ctx.body = { success: false, message: \"failed to get diff details or invalid format\" }\n       return\n     }\n-    console.log(\"🚀 ~ 获取完成pr信息 ~ data 成功，共\", data.patches.length, \"个 patches\")\n+    console.log(\"🚀 ~ 获取 diffs & system prompt 成功，共\", data.patches.length, \"个 patches\");\n+\n+    // 1.5 使用初始 Query ID 初始化会话\n+    const initialSessionOk = await initializeSessionWithSystemPrompt(repo_name, systemPrompt, currentQueryId, \"[初始会话] \");\n+    if (!initialSessionOk) {\n+      console.error(\"🚨 ~ 初始化会话失败 (发送或轮询初始 System Prompt 出错).\");\n+      ctx.status = 500;\n+      ctx.body = {\n+        success: false,\n+        message: \"Failed to initialize session with system prompt.\",\n+        queryIds: queryIdsUsed\n+      };\n+      return; // 中止处理\n+    }\n \n     // 2. 遍历 patches，依次发送消息并获取结果 (允许重试)\n-    for (let i = 0; i < data.patches.length; i++) { // 注意: 循环条件不变\n-      const patch = data.patches[i];\n-      const currentAttempt = (retryCounts[i] || 0) + 1; // 当前是第几次尝试 (包括首次)\n-      console.log(`======  🚀 ~ 处理 Patch ${i + 1}/${data.patches.length} (Attempt ${currentAttempt}) patchLength: ${patch.length} ======`)\n+    console.log(\"🚀 ~ 开始处理 Patches...\");\n+    const CALL_PATCH_REVIEW = 'Please follow the requirements to REVIEW the multiple file diff code provided below.'\n+    for (let i = 0; i < data.patches.length; i++) {\n+      const patch = CALL_PATCH_REVIEW + data.patches[i];\n+      const currentAttempt = (retryCounts[i] || 0) + 1;\n+      console.log(`======  🚀 ~ 处理 Patch ${i + 1}/${data.patches.length} (Attempt ${currentAttempt} using Query ID: ${currentQueryId}) patchLength: ${patch.length} ======`)\n \n       try {\n         // 2.1 发送当前 patch\n-        const sendResultData = await sendMessage(repo_name, patch, currentQueryId) // 使用 currentQueryId\n+        const sendResultData = await sendMessage(repo_name, patch, currentQueryId)\n         if (!sendResultData) {\n-          console.error(`🚀 ~ 发送 Patch ${i + 1} (Attempt ${currentAttempt}) 失败: sendMessage returned falsy`)\n-          throw new Error(\"Send message returned falsy\"); // 抛出错误进入 catch 处理重试\n+          console.error(`🚀 ~ 发送 Patch ${i + 1} (Attempt ${currentAttempt}, Query ID: ${currentQueryId}) 失败: sendMessage returned falsy`)\n+          throw new Error(\"Send message returned falsy\");\n         }\n-        console.log(`🚀 ~ 发送 Patch ${i + 1} (Attempt ${currentAttempt}) 成功`, sendResultData)\n+        console.log(`🚀 ~ 发送 Patch ${i + 1} (Attempt ${currentAttempt}) 成功`)\n \n         // 2.2 轮询获取当前 patch 的结果\n-        const pollingResultData = await pollingResponse(currentQueryId) // 使用 currentQueryId\n+        const pollingResultData = await pollingResponse(currentQueryId)\n         console.log(`🚀 ~ 轮询 Patch ${i + 1} (Attempt ${currentAttempt}) 结束:`, pollingResultData ? '有数据' : '无数据')\n         if (!pollingResultData) {\n-          // 如果轮询明确返回失败 (非异常)，也视为需要重试的错误\n-          console.error(`🚀 ~ 轮询 Patch ${i + 1} (Attempt ${currentAttempt}) 失败: pollingResponse returned falsy`)\n-          throw new Error(\"Polling response returned falsy\"); // 抛出错误进入 catch 处理重试\n+          console.error(`🚀 ~ 轮询 Patch ${i + 1} (Attempt ${currentAttempt}, Query ID: ${currentQueryId}) 失败: pollingResponse returned falsy`)\n+          throw new Error(\"Polling response returned falsy\");\n         }\n \n         // 存储当前 patch 的结果\n@@ -110,35 +156,39 @@ router.post(\"/getResult\", async (ctx) => {\n \n       } catch (error) {\n         // 捕获 pollingResponse 或上面抛出的错误\n-        console.warn(`🚀 ~ 处理 Patch ${i + 1} (Attempt ${currentAttempt}) 捕获异常:`, error)\n+        console.warn(`🚀 ~ 处理 Patch ${i + 1} (Attempt ${currentAttempt}, Query ID: ${currentQueryId}) 捕获异常:`, error)\n \n-        retryCounts[i] = (retryCounts[i] || 0) + 1; // 增加当前 patch 的重试计数\n+        retryCounts[i] = (retryCounts[i] || 0) + 1;\n \n         if (retryCounts[i] <= MAX_RETRIES_PER_PATCH) {\n           // 如果还没达到最大重试次数\n-          console.log(\"   ~ 当前已收集结果数量:\", chatResults.length)\n-          console.log(\"   ~ 已使用的 Query IDs:\", queryIdsUsed)\n-\n-          // 生成新的 query_id 并添加到列表中\n+          const previousQueryId = currentQueryId; // 保存旧 ID 用于日志\n           currentQueryId = generateUUID()\n           queryIdsUsed.push(currentQueryId)\n-          console.log(`   ~ 创建新的 Query ID: ${currentQueryId} 用于重试 Patch ${i + 1}`)\n+          console.log(`   ~ 创建新的 Query ID: ${currentQueryId} 用于重试 Patch ${i + 1} (旧 ID: ${previousQueryId})`)\n \n-          // !!! 关键: 减少 i，以便下一次循环迭代再次处理相同的索引 i\n-          i--;\n-          console.log(`   ~ 将重试 Patch ${i + 2}`) // 因为 i-- 了，所以下一个循环的 i+1 还是当前这个 patch\n+          // === 使用新 Query ID 初始化会话 (用于重试) ===\n+          const retrySessionOk = await initializeSessionWithSystemPrompt(repo_name, systemPrompt, currentQueryId, \"[重试会话] \");\n+          if (!retrySessionOk) {\n+            // 即使 System Prompt 初始化失败，仍然尝试发送 patch\n+            console.warn(`   ~ [重试会话] 初始化失败，但仍将继续尝试发送 Patch ${i + 1} (Query ID: ${currentQueryId})`);\n+          } else {\n+            console.log(`   ~ [重试会话] 初始化成功 (Query ID: ${currentQueryId}).`);\n+          }\n+          // === 初始化结束 ===\n+\n+          i--; // 减少 i，以便下次循环重试当前 patch\n+          console.log(`   ~ 将使用新的 Query ID (${currentQueryId}) 重试 Patch ${i + 2}`)\n \n         } else {\n           // 达到最大重试次数\n-          console.error(`🚀 ~ Patch ${i + 1} 达到最大重试次数 (${MAX_RETRIES_PER_PATCH}). 跳过此 patch.`);\n-          // 不执行 i--，让 for 循环正常进入下一个 patch (i++)\n-          // 可以考虑在这里记录下哪个 patch 最终失败了\n+          console.error(`❌ ~ Patch ${i + 1} 达到最大重试次数 (${MAX_RETRIES_PER_PATCH}). 跳过此 patch.`);\n         }\n       }\n     }\n \n     // 3. 所有 patches 处理完成 (可能部分跳过)，返回聚合结果和所有 query_id\n-    console.log(\"🚀 ~ 所有 Patches 处理完成\")\n+    console.log(\"✅ ~ 所有 Patches 处理完成\")\n     ctx.status = 200\n     ctx.body = {\n       success: true,\n@@ -148,15 +198,21 @@ router.post(\"/getResult\", async (ctx) => {\n       }\n     }\n   } catch (error: any) {\n-    console.error(\"🚀 ~ getResult 顶层错误:\", error)\n-    ctx.status = 500\n-    // 在顶层错误中也返回已收集的信息\n-    ctx.body = {\n-      success: false,\n-      message: `failed to get result: ${error.message}`,\n-      error: error.message,\n-      queryIds: queryIdsUsed,\n-      resultsSoFar: chatResults\n+    // 捕获顶层错误（例如 fetch 失败或初始 system prompt 失败后抛出的错误）\n+    console.error(\"❌ ~ getResult 顶层错误:\", error)\n+    // 检查是否已设置状态码，如果没有（说明是 fetch 之前的错误），则设为 500\n+    if (!ctx.status || ctx.status < 400) {\n+      ctx.status = 500;\n+    }\n+    // 确保即使在顶层错误中也返回一致的结构\n+    if (!ctx.body) {\n+      ctx.body = {\n+        success: false,\n+        message: `failed to get result: ${error.message}`,\n+        error: error.message,\n+        queryIds: queryIdsUsed, // 可能只包含初始 ID\n+        resultsSoFar: chatResults // 可能为空\n+      };\n     }\n   }\n })"
          }
        ]
      }
    ]
  }
]
成功获取 1 个仓库的分析结果。
  仓库: gijela/cr-mentor, 分支: main, Commits 数量: 2
    首个 Commit SHA: c575764539174ca5ec8926fec00fa3d98131f060, 消息: "refactor(koa-server): improve PR review process and rename prompt files", 文件变更数: 4
      首个 Commit 中的首个文件: koa-server/src/app/prompt/github/patch-summary.ts, 状态: renamed
--- analyzeUserActivity API 响应结束 ---

--- GitHub API 接口测试完成。 ---