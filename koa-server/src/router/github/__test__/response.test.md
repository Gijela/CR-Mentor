## æµ‹è¯•è¿”å›ç»“æœ
--- å¼€å§‹ GitHub API æ¥å£æµ‹è¯• ---

[æµ‹è¯•] è°ƒç”¨ analyzeUserActivity æ¥å£...
æµ‹è¯•è¯·æ±‚ä½“: {
  "repositories": [
    {
      "owner": "gijela",
      "repoName": "cr-mentor",
      "branchName": "main"
    }
  ],
  "timeRange": {
    "since": "2025-05-01T00:00:00Z",
    "until": "2025-05-02T00:00:00Z"
  },
  "targetUsername": "Gijela"
}
æ­£åœ¨å‘é€è¯·æ±‚åˆ°: http://localhost:4000/github/analyzeUserActivity
responseçŠ¶æ€: 200 OK

--- analyzeUserActivity API å“åº” ---
çŠ¶æ€: 200
å“åº”æ•°æ®:
[
  {
    "owner": "gijela",
    "repoName": "cr-mentor",
    "branchName": "main",
    "commits": [
      {
        "sha": "c575764539174ca5ec8926fec00fa3d98131f060",
        "message": "refactor(koa-server): improve PR review process and rename prompt files\n\n- Rename system-prompt.ts to patch-summary.ts for better clarity\n- Add new pr-summary.ts file for generating PR summary prompt\n- Update prompt content to provide more detailed instructions for reviewers\n- Modify controller and router to use new prompt files\n- Enhance error handling and response structure in deepwiki router",
        "date": "2025-05-01T16:17:43Z",
        "files": [
          {
            "filename": "koa-server/src/app/prompt/github/patch-summary.ts",
            "status": "renamed",
            "patch": "@@ -1,5 +1,4 @@\n-\n-export const buildSystemPrompt = (prTitle: string, prDesc: string, commitMessages: string[]) => {\n+export const buildPatchSummaryPrompt = (prTitle: string, prDesc: string, commitMessages: string[]) => {\n   return `\n # Character Description\n You are an experienced Code Reviewer, specializing in identifying critical functional issues, logical errors, vulnerabilities, and major performance problems in Pull Requests (PRs).\n@@ -22,7 +21,7 @@ You have two Pull Request review task with basic information:\n ## Task 1: Summarize the Pull Request\n Provider your response in markdown with the following content. \n   - **Walkthrough**:  A high-level summary of the overall change instead of specific files within 80 words.\n-  - **Changes**: A markdown table of files and their summaries. Group files with similar changes together into a single row to save space.\n+  - **Changes**: A markdown table of filesã€change type(feat, fix, refactor, perf, test, chore, style, ci, docs, revert) and their summaries. Group files with similar changes together into a single row to save space.\n \n ### Additional Instructions:\n - Carefully check the markdown format. If there are any errors, fix them before providing the final result."
          },
          {
            "filename": "koa-server/src/app/prompt/github/pr-summary.ts",
            "status": "added",
            "patch": "@@ -0,0 +1,36 @@\n+export const buildPrSummaryPrompt = (deletedFiles: string[], chatResults: string[]) => `\n+Hello, in this session, we will focus on analyzing a specific Pull Request (PR). \n+Your primary task is to process the independent review results for a series of different patch sections of the PR that I will provide next.\n+You need to merge these results based on the overall repository analysis and summarize them into a single, final report covering the entire PR. \n+Please ensure that the format and structure of the final report are consistent with the original results.\n+After you complete and generate this consolidated report, please be prepared to answer any follow-up questions I might have about this PR.\n+At that time, you can use the original review results I provided and the summary report you generated as the basis for our discussion.\n+\n+**Important Requirement:**\n+- The following files were deleted in this Pull Request. You **MUST** include these deleted files in the final \"Changes\" table along with the other modified files.\n+-  Group files with similar changes together into a single row to save space as far as possible.\n+-  If the \"Changes\" table becomes very long, especially with many deleted files, consider merging similar entries for brevity.\n+\n+Deleted Files:\n+${deletedFiles.map(file => `- ${file}`).join('\\n')}\\n\\n\n+\n+**Merging Suggestion:**\n+- If the \"Changes\" table becomes very long, especially with many deleted files, consider merging similar entries for brevity. \n+- For example, you could group multiple deleted files under a single entry like \"Multiple configuration files deleted\" or similar, if appropriate. \n+- Use your best judgment to keep the table informative yet concise.\n+- During the merge process, you must keep the path and line for each issue found by the code review\n+\n+**Visual Aids:**\n+To further improve clarity for the reviewer, consider incorporating simple visual aids or references that show **before-and-after comparisons** reflecting the PR's changes. Focus on diagrams that clearly illustrate the impact of the PR:\n+*   **Module/Component Impact Comparison:** Show how module relationships or dependencies change.\n+*   **Structural Comparison:** For significant refactoring or architectural changes, illustrate the structural differences (e.g., using simplified architecture diagrams).\n+*   **Flow/Sequence Diagram Comparison:** If key processes or interactions are altered, compare the sequence diagrams before and after the change.\n+*   **Class Diagram Comparison:** If core class structures are modified, show the differences.\n+*   **UI Comparison:** For visual changes, reference or include before-and-after screenshots/mockups.\n+Use your judgment on whether a visual aid adds significant value and can be concisely represented or referenced. The goal is to clearly show the *change* introduced by the PR.\n+\n+Please now merge the review summaries of the multiple patches provided below AND incorporate the deleted files list above into a single, \n+complete PR summary report, ensuring the \"Changes\" table includes all modified AND deleted files.\\n\\n\n+Patch Summaries to Merge:\n+${chatResults}\n+`\n\\ No newline at end of file"
          },
          {
            "filename": "koa-server/src/controller/github/index.ts",
            "status": "modified",
            "patch": "@@ -5,7 +5,7 @@ import logger from \"@/utils/logger\"\n import { formatAndGroupDiff } from \"@/lib/groupDiff\"\n import { EDIT_TYPE } from \"@/lib/groupDiff/types\"\n import { FileObject } from \"./types\"\n-import { buildSystemPrompt } from \"@/app/prompt/github/system-prompt\"\n+import { buildPatchSummaryPrompt } from \"@/app/prompt/github/patch-summary\"\n \n // æ ¹æ® githubName åˆ›å»º token\n export const createToken = async (ctx: Koa.Context) => {\n@@ -225,7 +225,7 @@ export const getDiffsDetails = async (ctx: Koa.Context) => {\n     const { files, commits }: { files: FileObject[], commits: any[] } = await response.json()\n     const commitMessages = commits.map(commit => commit.commit.message)\n     const CALL_DEEPWIKI_REPO = 'Based on the current repository information, please play the following role to help me review the code, before opening the diff code review, I need you to clarify your task, after you correctly clarify, I will provide you with the diff code.'\n-    const systemPrompt = CALL_DEEPWIKI_REPO + buildSystemPrompt(prTitle, prDesc, commitMessages)\n+    const systemPrompt = CALL_DEEPWIKI_REPO + buildPatchSummaryPrompt(prTitle, prDesc, commitMessages)\n \n     // 4. æ™ºèƒ½åˆ†ç»„ diff\n     const diffFiles = files.map(file => ({\n@@ -235,7 +235,7 @@ export const getDiffsDetails = async (ctx: Koa.Context) => {\n     const result = formatAndGroupDiff(modelMaxToken, diffFiles, systemPrompt);\n \n     ctx.status = 200\n-    ctx.body = { success: true, data: result, s: result.patches[0], systemPrompt }\n+    ctx.body = { success: true, data: result, systemPrompt }\n   } catch (error) {\n     logger.error(\"ğŸš€ ~ getDiffsDetails ~ error:\", error)\n     ctx.status = 500"
          },
          {
            "filename": "koa-server/src/router/deepwiki/index.ts",
            "status": "modified",
            "patch": "@@ -4,6 +4,7 @@ const router = new Router({ prefix: \"/deepwiki\" })\n \n import { sendMessage, pollingResponse, generateUUID } from \"@/controller/deepwiki/utils\"\n import { HandleLargeDiffResult } from \"@/lib/groupDiff/types\"\n+import { buildPrSummaryPrompt } from \"@/app/prompt/github/pr-summary\";\n \n // // å‘é€æ¶ˆæ¯\n // router.post(\"/sendMessage\", async (ctx) => {\n@@ -39,28 +40,28 @@ async function initializeSessionWithSystemPrompt(\n   systemPrompt: string,\n   query_id: string,\n   logPrefix: string = \"\" // å¯é€‰çš„æ—¥å¿—å‰ç¼€ï¼Œç”¨äºåŒºåˆ†è°ƒç”¨åœºæ™¯\n-): Promise<boolean> {\n+): Promise<{ success: boolean, message: string, content: string, error?: any }> {\n   console.log(`${logPrefix}ğŸš€ ~ ä½¿ç”¨ Query ID (${query_id}) å‘é€ System Prompt...`);\n   try {\n     const sendResult = await sendMessage(repo_name, systemPrompt, query_id);\n-    if (!sendResult) {\n+    if (!sendResult || !sendResult?.status) {\n       console.error(`${logPrefix}ğŸš¨ ~ å‘é€ System Prompt (Query ID: ${query_id}) å¤±è´¥: sendMessage returned falsy.`);\n-      return false; // å‘é€å¤±è´¥\n+      return { success: false, message: 'failed to send message', content: '' }; // å‘é€å¤±è´¥\n     }\n     console.log(`${logPrefix}   ~ System Prompt (Query ID: ${query_id}) å‘é€æˆåŠŸ, å¼€å§‹è½®è¯¢...`);\n \n-    const pollingResult = await pollingResponse(query_id);\n-    if (!pollingResult) {\n+    const { isDone, content } = await pollingResponse(query_id);\n+    if (!isDone) {\n       console.warn(`${logPrefix}âš ï¸ ~ è½®è¯¢ System Prompt (Query ID: ${query_id}) å¤±è´¥: pollingResponse returned falsy.`);\n       // æ³¨æ„ï¼šå³ä½¿è½®è¯¢å¤±è´¥ï¼Œå¯¹äºé‡è¯•åœºæ™¯ï¼Œæˆ‘ä»¬å¯èƒ½ä»å¸Œæœ›ç»§ç»­ã€‚\n       // ä½†å¯¹äºåˆå§‹åœºæ™¯ï¼Œè¿™é€šå¸¸è¡¨ç¤ºå¤±è´¥ã€‚è°ƒç”¨è€…éœ€è¦æ ¹æ®è¿”å›å€¼å†³å®šå¦‚ä½•å¤„ç†ã€‚\n-      return false; // è½®è¯¢å¤±è´¥/æ— ç»“æœ\n+      return { success: false, message: 'failed to polling response', content: '' }; // è½®è¯¢å¤±è´¥/æ— ç»“æœ\n     }\n     console.log(`${logPrefix}   ~ System Prompt (Query ID: ${query_id}) å¤„ç†å®Œæˆ.`);\n-    return true; // æˆåŠŸ\n+    return { success: true, message: 'success', content }; // æˆåŠŸ\n   } catch (error: any) {\n     console.error(`${logPrefix}ğŸš¨ ~ å¤„ç† System Prompt (Query ID: ${query_id}) æ—¶å‘ç”Ÿå¼‚å¸¸:`, error);\n-    return false; // å‘ç”Ÿå¼‚å¸¸\n+    return { success: false, message: 'failed to initialize session with system prompt', content: '', error }; // å‘ç”Ÿå¼‚å¸¸\n   }\n }\n \n@@ -112,7 +113,7 @@ router.post(\"/getResult\", async (ctx) => {\n     console.log(\"ğŸš€ ~ è·å– diffs & system prompt æˆåŠŸï¼Œå…±\", data.patches.length, \"ä¸ª patches\");\n \n     // 1.5 ä½¿ç”¨åˆå§‹ Query ID åˆå§‹åŒ–ä¼šè¯\n-    const initialSessionOk = await initializeSessionWithSystemPrompt(repo_name, systemPrompt, currentQueryId, \"[åˆå§‹ä¼šè¯] \");\n+    const { success: initialSessionOk } = await initializeSessionWithSystemPrompt(repo_name, systemPrompt, currentQueryId, \"[åˆå§‹ä¼šè¯] \");\n     if (!initialSessionOk) {\n       console.error(\"ğŸš¨ ~ åˆå§‹åŒ–ä¼šè¯å¤±è´¥ (å‘é€æˆ–è½®è¯¢åˆå§‹ System Prompt å‡ºé”™).\");\n       ctx.status = 500;\n@@ -126,7 +127,7 @@ router.post(\"/getResult\", async (ctx) => {\n \n     // 2. éå† patchesï¼Œä¾æ¬¡å‘é€æ¶ˆæ¯å¹¶è·å–ç»“æœ (å…è®¸é‡è¯•)\n     console.log(\"ğŸš€ ~ å¼€å§‹å¤„ç† Patches...\");\n-    const CALL_PATCH_REVIEW = 'Please follow the requirements to REVIEW the multiple file diff code provided below.'\n+    const CALL_PATCH_REVIEW = 'Please follow the requirements to review the multiple file diff code provided below.'\n     for (let i = 0; i < data.patches.length; i++) {\n       const patch = CALL_PATCH_REVIEW + data.patches[i];\n       const currentAttempt = (retryCounts[i] || 0) + 1;\n@@ -168,7 +169,7 @@ router.post(\"/getResult\", async (ctx) => {\n           console.log(`   ~ åˆ›å»ºæ–°çš„ Query ID: ${currentQueryId} ç”¨äºé‡è¯• Patch ${i + 1} (æ—§ ID: ${previousQueryId})`)\n \n           // === ä½¿ç”¨æ–° Query ID åˆå§‹åŒ–ä¼šè¯ (ç”¨äºé‡è¯•) ===\n-          const retrySessionOk = await initializeSessionWithSystemPrompt(repo_name, systemPrompt, currentQueryId, \"[é‡è¯•ä¼šè¯] \");\n+          const { success: retrySessionOk } = await initializeSessionWithSystemPrompt(repo_name, systemPrompt, currentQueryId, \"[é‡è¯•ä¼šè¯] \");\n           if (!retrySessionOk) {\n             // å³ä½¿ System Prompt åˆå§‹åŒ–å¤±è´¥ï¼Œä»ç„¶å°è¯•å‘é€ patch\n             console.warn(`   ~ [é‡è¯•ä¼šè¯] åˆå§‹åŒ–å¤±è´¥ï¼Œä½†ä»å°†ç»§ç»­å°è¯•å‘é€ Patch ${i + 1} (Query ID: ${currentQueryId})`);\n@@ -189,12 +190,26 @@ router.post(\"/getResult\", async (ctx) => {\n \n     // 3. æ‰€æœ‰ patches å¤„ç†å®Œæˆ (å¯èƒ½éƒ¨åˆ†è·³è¿‡)ï¼Œè¿”å›èšåˆç»“æœå’Œæ‰€æœ‰ query_id\n     console.log(\"âœ… ~ æ‰€æœ‰ Patches å¤„ç†å®Œæˆ\")\n+\n+    // 4. ç”Ÿæˆ summary\n+    const summaryQueryId = generateUUID()\n+    const summaryPrompt = buildPrSummaryPrompt(data.deletedFiles, chatResults)\n+\n+    const { success: finalSessionOk, content: summaryContent, error: summaryError } = await initializeSessionWithSystemPrompt(repo_name, summaryPrompt, summaryQueryId, \"[summary] \");\n+    if (!finalSessionOk) {\n+      console.error(\"ğŸš¨ ~ åˆå§‹åŒ–ä¼šè¯å¤±è´¥ (å‘é€æˆ–è½®è¯¢åˆå§‹ System Prompt å‡ºé”™).\");\n+      ctx.status = 500;\n+      ctx.body = { success: false, message: \"Failed to initialize session with system prompt.\", queryIds: queryIdsUsed, summaryQueryId, summaryError };\n+      return; // ä¸­æ­¢å¤„ç†\n+    }\n     ctx.status = 200\n     ctx.body = {\n       success: true,\n       data: {\n         chatResults: chatResults, // åªåŒ…å«æˆåŠŸè·å–ç»“æœçš„ patch\n-        queryIds: queryIdsUsed    // åŒ…å«æ‰€æœ‰å°è¯•è¿‡çš„ queryId\n+        chatQueryIds: queryIdsUsed,    // åŒ…å«æ‰€æœ‰å°è¯•è¿‡çš„ queryId\n+        summaryQueryId,\n+        summaryContent\n       }\n     }\n   } catch (error: any) {"
          }
        ]
      },
      {
        "sha": "e748de4110ba683d5c88efd12d350eb243b637df",
        "message": "refactor(koa-server): improve system prompt handling and patch processing\n\n- Update system prompt structure and content\n- Add initialization step with system prompt before patch review\n- Improve error handling and logging throughout the process\n- Refactor patch processing loop for better retry management\n- Update API response structure for consistency",
        "date": "2025-05-01T12:03:37Z",
        "files": [
          {
            "filename": "koa-server/src/app/prompt/github/system-prompt.ts",
            "status": "modified",
            "patch": "@@ -1,61 +1,64 @@\n \n-export const buildSystemPrompt = (prTitle, prDesc, commitMessages) => {\n+export const buildSystemPrompt = (prTitle: string, prDesc: string, commitMessages: string[]) => {\n   return `\n-    # Character Description\n-    You are an experienced Code Reviewer, specializing in identifying critical functional issues, logical errors, vulnerabilities, and major performance problems in Pull Requests (PRs).\n-\n-    # Skills Description\n-    ## Skill 1: Pull Request Summarize\n-    You excel at analyzing users' code changes and generating precise summaries.\n-    You are focused on highlighting critical code changes that may lead to severe issues or errors.\n-\n-    ## Skill 2: Code Review\n-    You are an AI Assistant specialized in reviewing pull requests with a focus on critical issues.\n-\n-    # Task\n-    You have two Pull Request review task with basic information:\n-\n-    ## Task 1: Summarize the Pull Request\n-    Provider your response in markdown with the following content. \n-      - **Walkthrough**:  A high-level summary of the overall change instead of specific files within 80 words.\n-      - **Changes**: A markdown table of files and their summaries. Group files with similar changes together into a single row to save space.\n-\n-    ### Additional Instructions:\n-    - Carefully check the markdown format. If there are any errors, fix them before providing the final result.\n-    - Respond in the language of the PR title and content (e.g., if the title/content is in Chinese, reply in Chinese; if it's in English, reply in English).\n-    - At the end of the conversation, be sure to include the following wording and adhere to the language used in previous conversations:\n-\n-    ## Task 2: Code Review\n-\n-    Review the code diff exclusively for critical logical, functional, or security errors. Avoid any commentary unrelated to these areas, including documentation, stylistic changes, or minor issues.\n-\n-    ### Specific Instructions:\n-\n-    - Only the code diff is provided, but you need to review it in the context of the full repository codebase.\n-    - Make comments only on code introducing clear and critical functional or security errors.\n-    - Do not comment on documentation, style, accuracy of text, or minor refactoring changes.\n-    - If necessary, provide code examples only for addressing critical errors.\n-    - Adhere to language-specific coding conventions used in the PR.\n-    - Avoid providing suggestions related to code optimization or best practices (e.g., \"ensure\" or \"make sure\") unless they address critical errors.\n-    - Skip the task entirely if no critical errors are found in the code diff.\n-    - Upon completing the task, output strictly \"All task finished\", with no additional commentary.\n-\n-\n-    ### Input format\n-\n-    - The input format follows Github diff format with addition and subtraction of code.\n-    - The + sign means that code has been added.\n-    - The - sign means that code has been removed.\n-\n-    # Skip Task Whitelist\n-    **SKIP_KEYWORDS**: A list of keywords. If any of these keywords are present in the PR title or description, the corresponding task will be skipped.\n-    - Examples: \"skip\", \"ignore\", \"wip\", \"merge\", \"[skip ci]\"\n-    - If the draft flag is set to true, the task should be skipped.\n-\n-    # Constraints\n-    - Strictly avoid commenting on minor style inconsistencies, formatting issues, or changes that do not impact functionality.\n-    - Only flag code changes that introduce serious problems (logical errors, security vulnerabilities, typo or functionality-breaking bugs).\n-    - Respect the language of the PRâ€™s title and description when providing summaries and comments (e.g., English or Chinese).\n+# Character Description\n+You are an experienced Code Reviewer, specializing in identifying critical functional issues, logical errors, vulnerabilities, and major performance problems in Pull Requests (PRs).\n+\n+# Skills Description\n+## Skill 1: Pull Request Summarize\n+You excel at analyzing users' code changes and generating precise summaries.\n+You are focused on highlighting critical code changes that may lead to severe issues or errors.\n+\n+## Skill 2: Code Review\n+You are an AI Assistant specialized in reviewing pull requests with a focus on critical issues.\n+\n+# Task\n+You have two Pull Request review task with basic information:\n+- **PR Title**: ${prTitle}\n+- **PR Description**: ${prDesc}\n+- **Commit Messages**: \n+  ${commitMessages.map(message => `- ${message}`).join(\"\\n\")}\n+\n+## Task 1: Summarize the Pull Request\n+Provider your response in markdown with the following content. \n+  - **Walkthrough**:  A high-level summary of the overall change instead of specific files within 80 words.\n+  - **Changes**: A markdown table of files and their summaries. Group files with similar changes together into a single row to save space.\n+\n+### Additional Instructions:\n+- Carefully check the markdown format. If there are any errors, fix them before providing the final result.\n+- Respond in the language of the PR title and content (e.g., if the title/content is in Chinese, reply in Chinese; if it's in English, reply in English).\n+- At the end of the conversation, be sure to include the following wording and adhere to the language used in previous conversations:\n+\n+## Task 2: Code Review\n+\n+Review the code diff exclusively for critical logical, functional, or security errors. Avoid any commentary unrelated to these areas, including documentation, stylistic changes, or minor issues.\n+\n+### Specific Instructions:\n+\n+- Only the code diff is provided, but you need to review it in the context of the full repository codebase.\n+- Make comments only on code introducing clear and critical functional or security errors.\n+- Do not comment on documentation, style, accuracy of text, or minor refactoring changes.\n+- If necessary, provide code examples only for addressing critical errors.\n+- Adhere to language-specific coding conventions used in the PR.\n+- Avoid providing suggestions related to code optimization or best practices (e.g., \"ensure\" or \"make sure\") unless they address critical errors.\n+- Skip the task entirely if no critical errors are found in the code diff.\n+- For every issue mentioned in a comment, the path and line must be provided.(path: The relative path of the file being reviewed. line: The line number in the pull request diff view to which the comment applies, not the line number in the original source file.)\n+\n+### Input format\n+\n+- The input format follows Github diff format with addition and subtraction of code.\n+- The + sign means that code has been added.\n+- The - sign means that code has been removed.\n+\n+# Skip Task Whitelist\n+**SKIP_KEYWORDS**: A list of keywords. If any of these keywords are present in the PR title or description, the corresponding task will be skipped.\n+- Examples: \"skip\", \"ignore\", \"wip\", \"merge\", \"[skip ci]\"\n+- If the draft flag is set to true, the task should be skipped.\n+\n+# Constraints\n+- Strictly avoid commenting on minor style inconsistencies, formatting issues, or changes that do not impact functionality.\n+- Only flag code changes that introduce serious problems (logical errors, security vulnerabilities, typo or functionality-breaking bugs).\n+- Respect the language of the PRâ€™s title and description when providing summaries and comments (e.g., English or Chinese).\n `\n }\n "
          },
          {
            "filename": "koa-server/src/controller/github/index.ts",
            "status": "modified",
            "patch": "@@ -188,7 +188,7 @@ export const createPullRequest = async (ctx: Koa.Context) => {\n \n // è·å– diffs è¯¦æƒ…\n export const getDiffsDetails = async (ctx: Koa.Context) => {\n-  const { prTitle, prDesc, githubName, compareUrl, baseLabel, headLabel, modelMaxToken = 100000 } = ctx.request.body as any\n+  const { prTitle, prDesc, githubName, compareUrl, baseLabel, headLabel, modelMaxToken = 25000 } = ctx.request.body as any\n \n   try {\n     // 1. åˆ›å»ºtoken\n@@ -224,7 +224,8 @@ export const getDiffsDetails = async (ctx: Koa.Context) => {\n     }\n     const { files, commits }: { files: FileObject[], commits: any[] } = await response.json()\n     const commitMessages = commits.map(commit => commit.commit.message)\n-    const systemPrompt = buildSystemPrompt(prTitle, prDesc, commitMessages)\n+    const CALL_DEEPWIKI_REPO = 'Based on the current repository information, please play the following role to help me review the code, before opening the diff code review, I need you to clarify your task, after you correctly clarify, I will provide you with the diff code.'\n+    const systemPrompt = CALL_DEEPWIKI_REPO + buildSystemPrompt(prTitle, prDesc, commitMessages)\n \n     // 4. æ™ºèƒ½åˆ†ç»„ diff\n     const diffFiles = files.map(file => ({\n@@ -234,7 +235,7 @@ export const getDiffsDetails = async (ctx: Koa.Context) => {\n     const result = formatAndGroupDiff(modelMaxToken, diffFiles, systemPrompt);\n \n     ctx.status = 200\n-    ctx.body = { success: true, data: result }\n+    ctx.body = { success: true, data: result, s: result.patches[0], systemPrompt }\n   } catch (error) {\n     logger.error(\"ğŸš€ ~ getDiffsDetails ~ error:\", error)\n     ctx.status = 500"
          },
          {
            "filename": "koa-server/src/router/deepwiki/index.ts",
            "status": "modified",
            "patch": "@@ -33,6 +33,37 @@ import { HandleLargeDiffResult } from \"@/lib/groupDiff/types\"\n //   }\n // })\n \n+// è¾…åŠ©å‡½æ•°ï¼šå‘é€ System Prompt å¹¶ç­‰å¾…å“åº”\n+async function initializeSessionWithSystemPrompt(\n+  repo_name: string,\n+  systemPrompt: string,\n+  query_id: string,\n+  logPrefix: string = \"\" // å¯é€‰çš„æ—¥å¿—å‰ç¼€ï¼Œç”¨äºåŒºåˆ†è°ƒç”¨åœºæ™¯\n+): Promise<boolean> {\n+  console.log(`${logPrefix}ğŸš€ ~ ä½¿ç”¨ Query ID (${query_id}) å‘é€ System Prompt...`);\n+  try {\n+    const sendResult = await sendMessage(repo_name, systemPrompt, query_id);\n+    if (!sendResult) {\n+      console.error(`${logPrefix}ğŸš¨ ~ å‘é€ System Prompt (Query ID: ${query_id}) å¤±è´¥: sendMessage returned falsy.`);\n+      return false; // å‘é€å¤±è´¥\n+    }\n+    console.log(`${logPrefix}   ~ System Prompt (Query ID: ${query_id}) å‘é€æˆåŠŸ, å¼€å§‹è½®è¯¢...`);\n+\n+    const pollingResult = await pollingResponse(query_id);\n+    if (!pollingResult) {\n+      console.warn(`${logPrefix}âš ï¸ ~ è½®è¯¢ System Prompt (Query ID: ${query_id}) å¤±è´¥: pollingResponse returned falsy.`);\n+      // æ³¨æ„ï¼šå³ä½¿è½®è¯¢å¤±è´¥ï¼Œå¯¹äºé‡è¯•åœºæ™¯ï¼Œæˆ‘ä»¬å¯èƒ½ä»å¸Œæœ›ç»§ç»­ã€‚\n+      // ä½†å¯¹äºåˆå§‹åœºæ™¯ï¼Œè¿™é€šå¸¸è¡¨ç¤ºå¤±è´¥ã€‚è°ƒç”¨è€…éœ€è¦æ ¹æ®è¿”å›å€¼å†³å®šå¦‚ä½•å¤„ç†ã€‚\n+      return false; // è½®è¯¢å¤±è´¥/æ— ç»“æœ\n+    }\n+    console.log(`${logPrefix}   ~ System Prompt (Query ID: ${query_id}) å¤„ç†å®Œæˆ.`);\n+    return true; // æˆåŠŸ\n+  } catch (error: any) {\n+    console.error(`${logPrefix}ğŸš¨ ~ å¤„ç† System Prompt (Query ID: ${query_id}) æ—¶å‘ç”Ÿå¼‚å¸¸:`, error);\n+    return false; // å‘ç”Ÿå¼‚å¸¸\n+  }\n+}\n+\n type GetResultBody = {\n   githubName: string\n   compareUrl: string\n@@ -56,7 +87,8 @@ router.post(\"/getResult\", async (ctx) => {\n   const retryCounts: { [key: number]: number } = {}; // è®°å½•æ¯ä¸ª patch çš„é‡è¯•æ¬¡æ•°\n \n   try {\n-    // 1. è·å– diffs & åˆç†åˆ†ç»„ diffs\n+    // 1. è·å– diffs & systemPrompt\n+    console.log(\"ğŸš€ ~ å¼€å§‹è·å– diff è¯¦æƒ…å’Œ system prompt...\");\n     const response = await fetch(`${process.env.SERVER_HOST}/github/getDiffsDetails`, {\n       method: \"POST\",\n       headers: { \"Content-Type\": \"application/json\" },\n@@ -70,37 +102,51 @@ router.post(\"/getResult\", async (ctx) => {\n       return;\n     }\n \n-    const { success, data } = (await response.json()) as { success: boolean, data: HandleLargeDiffResult }\n-    if (!success || !data || !Array.isArray(data.patches)) {\n-      console.error(\"Invalid diff details response:\", { success, data });\n+    const { success, data, systemPrompt } = (await response.json()) as { success: boolean, data: HandleLargeDiffResult, systemPrompt: string }\n+    if (!success || !data || !Array.isArray(data.patches) || !systemPrompt) {\n+      console.error(\"Invalid diff details response:\", { success, data, systemPrompt });\n       ctx.status = 500\n       ctx.body = { success: false, message: \"failed to get diff details or invalid format\" }\n       return\n     }\n-    console.log(\"ğŸš€ ~ è·å–å®Œæˆprä¿¡æ¯ ~ data æˆåŠŸï¼Œå…±\", data.patches.length, \"ä¸ª patches\")\n+    console.log(\"ğŸš€ ~ è·å– diffs & system prompt æˆåŠŸï¼Œå…±\", data.patches.length, \"ä¸ª patches\");\n+\n+    // 1.5 ä½¿ç”¨åˆå§‹ Query ID åˆå§‹åŒ–ä¼šè¯\n+    const initialSessionOk = await initializeSessionWithSystemPrompt(repo_name, systemPrompt, currentQueryId, \"[åˆå§‹ä¼šè¯] \");\n+    if (!initialSessionOk) {\n+      console.error(\"ğŸš¨ ~ åˆå§‹åŒ–ä¼šè¯å¤±è´¥ (å‘é€æˆ–è½®è¯¢åˆå§‹ System Prompt å‡ºé”™).\");\n+      ctx.status = 500;\n+      ctx.body = {\n+        success: false,\n+        message: \"Failed to initialize session with system prompt.\",\n+        queryIds: queryIdsUsed\n+      };\n+      return; // ä¸­æ­¢å¤„ç†\n+    }\n \n     // 2. éå† patchesï¼Œä¾æ¬¡å‘é€æ¶ˆæ¯å¹¶è·å–ç»“æœ (å…è®¸é‡è¯•)\n-    for (let i = 0; i < data.patches.length; i++) { // æ³¨æ„: å¾ªç¯æ¡ä»¶ä¸å˜\n-      const patch = data.patches[i];\n-      const currentAttempt = (retryCounts[i] || 0) + 1; // å½“å‰æ˜¯ç¬¬å‡ æ¬¡å°è¯• (åŒ…æ‹¬é¦–æ¬¡)\n-      console.log(`======  ğŸš€ ~ å¤„ç† Patch ${i + 1}/${data.patches.length} (Attempt ${currentAttempt}) patchLength: ${patch.length} ======`)\n+    console.log(\"ğŸš€ ~ å¼€å§‹å¤„ç† Patches...\");\n+    const CALL_PATCH_REVIEW = 'Please follow the requirements to REVIEW the multiple file diff code provided below.'\n+    for (let i = 0; i < data.patches.length; i++) {\n+      const patch = CALL_PATCH_REVIEW + data.patches[i];\n+      const currentAttempt = (retryCounts[i] || 0) + 1;\n+      console.log(`======  ğŸš€ ~ å¤„ç† Patch ${i + 1}/${data.patches.length} (Attempt ${currentAttempt} using Query ID: ${currentQueryId}) patchLength: ${patch.length} ======`)\n \n       try {\n         // 2.1 å‘é€å½“å‰ patch\n-        const sendResultData = await sendMessage(repo_name, patch, currentQueryId) // ä½¿ç”¨ currentQueryId\n+        const sendResultData = await sendMessage(repo_name, patch, currentQueryId)\n         if (!sendResultData) {\n-          console.error(`ğŸš€ ~ å‘é€ Patch ${i + 1} (Attempt ${currentAttempt}) å¤±è´¥: sendMessage returned falsy`)\n-          throw new Error(\"Send message returned falsy\"); // æŠ›å‡ºé”™è¯¯è¿›å…¥ catch å¤„ç†é‡è¯•\n+          console.error(`ğŸš€ ~ å‘é€ Patch ${i + 1} (Attempt ${currentAttempt}, Query ID: ${currentQueryId}) å¤±è´¥: sendMessage returned falsy`)\n+          throw new Error(\"Send message returned falsy\");\n         }\n-        console.log(`ğŸš€ ~ å‘é€ Patch ${i + 1} (Attempt ${currentAttempt}) æˆåŠŸ`, sendResultData)\n+        console.log(`ğŸš€ ~ å‘é€ Patch ${i + 1} (Attempt ${currentAttempt}) æˆåŠŸ`)\n \n         // 2.2 è½®è¯¢è·å–å½“å‰ patch çš„ç»“æœ\n-        const pollingResultData = await pollingResponse(currentQueryId) // ä½¿ç”¨ currentQueryId\n+        const pollingResultData = await pollingResponse(currentQueryId)\n         console.log(`ğŸš€ ~ è½®è¯¢ Patch ${i + 1} (Attempt ${currentAttempt}) ç»“æŸ:`, pollingResultData ? 'æœ‰æ•°æ®' : 'æ— æ•°æ®')\n         if (!pollingResultData) {\n-          // å¦‚æœè½®è¯¢æ˜ç¡®è¿”å›å¤±è´¥ (éå¼‚å¸¸)ï¼Œä¹Ÿè§†ä¸ºéœ€è¦é‡è¯•çš„é”™è¯¯\n-          console.error(`ğŸš€ ~ è½®è¯¢ Patch ${i + 1} (Attempt ${currentAttempt}) å¤±è´¥: pollingResponse returned falsy`)\n-          throw new Error(\"Polling response returned falsy\"); // æŠ›å‡ºé”™è¯¯è¿›å…¥ catch å¤„ç†é‡è¯•\n+          console.error(`ğŸš€ ~ è½®è¯¢ Patch ${i + 1} (Attempt ${currentAttempt}, Query ID: ${currentQueryId}) å¤±è´¥: pollingResponse returned falsy`)\n+          throw new Error(\"Polling response returned falsy\");\n         }\n \n         // å­˜å‚¨å½“å‰ patch çš„ç»“æœ\n@@ -110,35 +156,39 @@ router.post(\"/getResult\", async (ctx) => {\n \n       } catch (error) {\n         // æ•è· pollingResponse æˆ–ä¸Šé¢æŠ›å‡ºçš„é”™è¯¯\n-        console.warn(`ğŸš€ ~ å¤„ç† Patch ${i + 1} (Attempt ${currentAttempt}) æ•è·å¼‚å¸¸:`, error)\n+        console.warn(`ğŸš€ ~ å¤„ç† Patch ${i + 1} (Attempt ${currentAttempt}, Query ID: ${currentQueryId}) æ•è·å¼‚å¸¸:`, error)\n \n-        retryCounts[i] = (retryCounts[i] || 0) + 1; // å¢åŠ å½“å‰ patch çš„é‡è¯•è®¡æ•°\n+        retryCounts[i] = (retryCounts[i] || 0) + 1;\n \n         if (retryCounts[i] <= MAX_RETRIES_PER_PATCH) {\n           // å¦‚æœè¿˜æ²¡è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°\n-          console.log(\"   ~ å½“å‰å·²æ”¶é›†ç»“æœæ•°é‡:\", chatResults.length)\n-          console.log(\"   ~ å·²ä½¿ç”¨çš„ Query IDs:\", queryIdsUsed)\n-\n-          // ç”Ÿæˆæ–°çš„ query_id å¹¶æ·»åŠ åˆ°åˆ—è¡¨ä¸­\n+          const previousQueryId = currentQueryId; // ä¿å­˜æ—§ ID ç”¨äºæ—¥å¿—\n           currentQueryId = generateUUID()\n           queryIdsUsed.push(currentQueryId)\n-          console.log(`   ~ åˆ›å»ºæ–°çš„ Query ID: ${currentQueryId} ç”¨äºé‡è¯• Patch ${i + 1}`)\n+          console.log(`   ~ åˆ›å»ºæ–°çš„ Query ID: ${currentQueryId} ç”¨äºé‡è¯• Patch ${i + 1} (æ—§ ID: ${previousQueryId})`)\n \n-          // !!! å…³é”®: å‡å°‘ iï¼Œä»¥ä¾¿ä¸‹ä¸€æ¬¡å¾ªç¯è¿­ä»£å†æ¬¡å¤„ç†ç›¸åŒçš„ç´¢å¼• i\n-          i--;\n-          console.log(`   ~ å°†é‡è¯• Patch ${i + 2}`) // å› ä¸º i-- äº†ï¼Œæ‰€ä»¥ä¸‹ä¸€ä¸ªå¾ªç¯çš„ i+1 è¿˜æ˜¯å½“å‰è¿™ä¸ª patch\n+          // === ä½¿ç”¨æ–° Query ID åˆå§‹åŒ–ä¼šè¯ (ç”¨äºé‡è¯•) ===\n+          const retrySessionOk = await initializeSessionWithSystemPrompt(repo_name, systemPrompt, currentQueryId, \"[é‡è¯•ä¼šè¯] \");\n+          if (!retrySessionOk) {\n+            // å³ä½¿ System Prompt åˆå§‹åŒ–å¤±è´¥ï¼Œä»ç„¶å°è¯•å‘é€ patch\n+            console.warn(`   ~ [é‡è¯•ä¼šè¯] åˆå§‹åŒ–å¤±è´¥ï¼Œä½†ä»å°†ç»§ç»­å°è¯•å‘é€ Patch ${i + 1} (Query ID: ${currentQueryId})`);\n+          } else {\n+            console.log(`   ~ [é‡è¯•ä¼šè¯] åˆå§‹åŒ–æˆåŠŸ (Query ID: ${currentQueryId}).`);\n+          }\n+          // === åˆå§‹åŒ–ç»“æŸ ===\n+\n+          i--; // å‡å°‘ iï¼Œä»¥ä¾¿ä¸‹æ¬¡å¾ªç¯é‡è¯•å½“å‰ patch\n+          console.log(`   ~ å°†ä½¿ç”¨æ–°çš„ Query ID (${currentQueryId}) é‡è¯• Patch ${i + 2}`)\n \n         } else {\n           // è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°\n-          console.error(`ğŸš€ ~ Patch ${i + 1} è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•° (${MAX_RETRIES_PER_PATCH}). è·³è¿‡æ­¤ patch.`);\n-          // ä¸æ‰§è¡Œ i--ï¼Œè®© for å¾ªç¯æ­£å¸¸è¿›å…¥ä¸‹ä¸€ä¸ª patch (i++)\n-          // å¯ä»¥è€ƒè™‘åœ¨è¿™é‡Œè®°å½•ä¸‹å“ªä¸ª patch æœ€ç»ˆå¤±è´¥äº†\n+          console.error(`âŒ ~ Patch ${i + 1} è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•° (${MAX_RETRIES_PER_PATCH}). è·³è¿‡æ­¤ patch.`);\n         }\n       }\n     }\n \n     // 3. æ‰€æœ‰ patches å¤„ç†å®Œæˆ (å¯èƒ½éƒ¨åˆ†è·³è¿‡)ï¼Œè¿”å›èšåˆç»“æœå’Œæ‰€æœ‰ query_id\n-    console.log(\"ğŸš€ ~ æ‰€æœ‰ Patches å¤„ç†å®Œæˆ\")\n+    console.log(\"âœ… ~ æ‰€æœ‰ Patches å¤„ç†å®Œæˆ\")\n     ctx.status = 200\n     ctx.body = {\n       success: true,\n@@ -148,15 +198,21 @@ router.post(\"/getResult\", async (ctx) => {\n       }\n     }\n   } catch (error: any) {\n-    console.error(\"ğŸš€ ~ getResult é¡¶å±‚é”™è¯¯:\", error)\n-    ctx.status = 500\n-    // åœ¨é¡¶å±‚é”™è¯¯ä¸­ä¹Ÿè¿”å›å·²æ”¶é›†çš„ä¿¡æ¯\n-    ctx.body = {\n-      success: false,\n-      message: `failed to get result: ${error.message}`,\n-      error: error.message,\n-      queryIds: queryIdsUsed,\n-      resultsSoFar: chatResults\n+    // æ•è·é¡¶å±‚é”™è¯¯ï¼ˆä¾‹å¦‚ fetch å¤±è´¥æˆ–åˆå§‹ system prompt å¤±è´¥åæŠ›å‡ºçš„é”™è¯¯ï¼‰\n+    console.error(\"âŒ ~ getResult é¡¶å±‚é”™è¯¯:\", error)\n+    // æ£€æŸ¥æ˜¯å¦å·²è®¾ç½®çŠ¶æ€ç ï¼Œå¦‚æœæ²¡æœ‰ï¼ˆè¯´æ˜æ˜¯ fetch ä¹‹å‰çš„é”™è¯¯ï¼‰ï¼Œåˆ™è®¾ä¸º 500\n+    if (!ctx.status || ctx.status < 400) {\n+      ctx.status = 500;\n+    }\n+    // ç¡®ä¿å³ä½¿åœ¨é¡¶å±‚é”™è¯¯ä¸­ä¹Ÿè¿”å›ä¸€è‡´çš„ç»“æ„\n+    if (!ctx.body) {\n+      ctx.body = {\n+        success: false,\n+        message: `failed to get result: ${error.message}`,\n+        error: error.message,\n+        queryIds: queryIdsUsed, // å¯èƒ½åªåŒ…å«åˆå§‹ ID\n+        resultsSoFar: chatResults // å¯èƒ½ä¸ºç©º\n+      };\n     }\n   }\n })"
          }
        ]
      }
    ]
  }
]
æˆåŠŸè·å– 1 ä¸ªä»“åº“çš„åˆ†æç»“æœã€‚
  ä»“åº“: gijela/cr-mentor, åˆ†æ”¯: main, Commits æ•°é‡: 2
    é¦–ä¸ª Commit SHA: c575764539174ca5ec8926fec00fa3d98131f060, æ¶ˆæ¯: "refactor(koa-server): improve PR review process and rename prompt files", æ–‡ä»¶å˜æ›´æ•°: 4
      é¦–ä¸ª Commit ä¸­çš„é¦–ä¸ªæ–‡ä»¶: koa-server/src/app/prompt/github/patch-summary.ts, çŠ¶æ€: renamed
--- analyzeUserActivity API å“åº”ç»“æŸ ---

--- GitHub API æ¥å£æµ‹è¯•å®Œæˆã€‚ ---